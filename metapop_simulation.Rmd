---
title: "Metapopulation Simulation"
author: "Owen Liu"
date: "Thursday, October 15, 2015"
output: html_document
---

```{r packages,echo=F,results='hide'}
library(RColorBrewer)
```

## Introduction and Project Goals

This is an exploration of the use of matrix population models to explore
population dynamics in a metapopulation context, in which local populations
can be demographically open or closed, and vary in their demographic rates,
especially in the survival of YOY, or new recruits.  First, the model formulation
will be general, then I will attempt to parameterize it for specific species.

Much of the model formulation is based on Caswell (2001) and adapted from
Armsworth(2002). The initial goals (subject to change) are to:

* practice building matrix models

* investigate measurements of stability and resilience using such models

* think about the consequences of metapopulation structure for resilience

* practice using RMarkdown and GitHub

## Model Construction

### Parameters for the matrix model(s)

Age-structured matrix model, where population is structured into $\omega$ age classes, and abundance denoted by $\textbf{N} = (N_{1},...,N_{\omega})$. A vector $\textbf{p}$ describes survival, where, for example, $p_{i}$ is the proportional survival of individuals from age $i$ to age $i+1$.  Similarly, $\textbf{f}_{i}$ is the fertility of individuals of age $i$.  $\xi$ is the number of external larvae supplied to a local population; $a \in [0,1]$ is the self-recruitment rate, that is, the proportion of locally produced larvae that return to that population; and $\gamma$ is the proportion of settlers that remain alive at the end of the first year.

```{r params}
max.age <- 14 # max age class (number of age classes will be this plus 1 (for age 0)
gamma <- 0.125 # proportion of settling larvae that survive the first year
ext <- 1000 # number of externally supplied larvae
e.vec <- c(1,rep(0,(max.age))) # allows addition of external larvae to the matrix
ret <- 0.5 # proportion of locally produced larvae that return (self-seeding proportion)
p.vec <- c(1,rep(0.863,max.age)) # survivorship vector (p.vec[i] is the survival from age i-2 to i-1)

## Rate of self-recruitment (placeholder; sampled from a beta distribution later)
a <- 0.001

## Von Bertalanffy parameters
Linf <- 52.2 #L infinity, asymptotic length
K <- 0.354 #growth rate
t0 <- -0.766 #theoretical age at zero length
vb <- c(Linf, K, t0) #concatenated 3 V-B growth params

## Fecundity/fertility/length relationship
repr.age <- 2 #age at first reproduction
f1 <- 0.0129
f2 <- 3.03

## Beverton-Holt parameter, for density-dependent model
B <- .0001 # (B-H beta parameter)

## Years for each simulation
sim.years <- 200
```

#### Von Bertalanffy Growth

The classic Von Bertalanffy Growth equation, of the form

$$L(t) = L_\infty(1-e^{-K(t-t_0)})$$

```{r VB Growth}
vb.growth <- function(age.vec,vb)  { 
  ## function that takes an age vector and a vector of V-B params, c(Linf, K, t0)
  ## returns a vector of lengths
  lengths <- sapply(age.vec, function(x) vb[1]*(1-exp(-vb[2]*(x-vb[3]))))
  return(lengths)
  }

## with our parameters:
l.vec <- vb.growth(age.vec=0:max.age,vb=vb) #vector of lengths (to be used later)
plot(0:max.age,l.vec,main="Age vs. Length",type='l',xlab='Age, years',ylab='Length, cm',
     xaxs='i')
```

#### Fecundity relationship

This function relates length to fecundity, and is a power function that can be parameterized on a species-specific basis.  Adopted from Sadovy (1996)

*Note: fecundity is zero until reproductive age (a parameter above) is reached*

```{r fertility function}
fert <- function(age.vec, vb, repr.age, f1,f2) {
  ## function that builds on VB equation above, taking three more parameters to calculate fertility
  ## as a function of age.
  ## From Armsworth (2002) and Sadovy (1996)
  l.vec <- vb.growth(age.vec=age.vec,vb=vb)
  f <- sapply(l.vec, function(x) f1*x^f2)
  f[1:repr.age] <- 0
  return(f)
}

# with our parameters:
f.vec <- fert(age.vec=0:max.age,vb=vb,repr.age=repr.age,f1=f1,f2=f2)
plot(0:max.age,f.vec,main="Age vs. Fecundity",type='l',xlab='Age, years',ylab='Fertility (# eggs)',
     xaxs='i')
```


#### Net Reproductive Rate

The net reproductive rate, $R$, is a useful concept, and is defined as the expected lifetime reproductive contribution from an individual that survives the first year, from Caswell (2001).  $R$ is useful because if $R\gamma$*a* (the expected per capita lifetime production of recruits) is less than 1, we can expect than the population will shrink (below replacement level; i.e. a *sink* population) because an individual is not expected to replace itself.  The converse is also true, that when $R\gamma$*a* is greater than 1, the population will be a *source* :

$$R = \sum_{t=1}^{\omega}f_{1}\prod_{k=0}^{t-1}p_{k}$$

```{r net repro rate}
net.R <- function(f.vec,p.vec) {
  p.cum <- numeric()
  for (i in 1:(max.age+1)) { #cumulative survival (i.e. vector of prob. surviving age 0:x)
    p.cum[i] <- prod(p.vec[1:i])
  }
  R <- sum(f.vec*p.cum)
  return(R)
}
```

### Local, density independent population

The density-independent model for a local population takes the form

$$\textbf{N}(\textit{t} + 1) = \textbf{MN}(\textit{t}) + \gamma\xi\textbf{e}$$

where **M** is a Leslie matrix, $\gamma$ is the proportion of settlers that survive the year, $\xi$ is the number of externally supplied larvae, and **e** is a vector to allow external larvae to effect the matrix. We will also use the defined parameter *a* $\in$ [0,1], which is the proportion of locally produced larvae that return to the same local adult population, i.e. the rate of self-recruitment.

We can now construct the Leslie matrix **M** :

```{r Leslie matrix density independent}
M.di <- function (a, gamma, f.vec, p.vec) {
  M=matrix(nrow=max.age+1,ncol=max.age+1)
  r1 <- f.vec*a*gamma #first row, allowing for a partially open population and settler mortality in year 1
  M[1,] <-r1
  for (i in 2:(max.age+1)) { #rows 2 to max age
    row <- numeric(max.age+1)
    row[i-1] <- p.vec[i]
    M[i,] <- row
  }
  return(M)
}
```

In this model formulation, the long-term growth or decline is determined by $R$ (or, equivalently, by the dominant eigenvalue of **M**), and consequently by the self-recruitment rate *a*.  Whether the population will grow or decline in the long-term is *not* determined by $\xi$, since it is an additive, not a multiplicative term.  $\xi$ will, however, influence abundance.  We will return to this model later in simulation.

### Local, density dependent population

It has been observed that there can be density-dependent dynamics early in the life-history, and we will model it here as density-dependence in the first year of life, where $S = a\sum_{t=1}^{\omega}f_{t}N_{t}+\xi$ is the larval supply, and $\Gamma(S(t))$ is a Beverton-Holt type relationship:

$$N_{1}(t) = \Gamma(S(t)) = \frac{\gamma S(t)}{1+\beta S(t)}$$

```{r S and Gamma B-H function}
S.dd <- function(a,f.vec,n.vec,ext) {
  a*sum(f.vec*n.vec)+ext
}

G <- function(a,f.vec,n.vec,ext,gamma,B) { #utilizes the S(t) equation above
  s <- S.dd(a,f.vec,n.vec,ext)
  out <- (gamma*s)/(1+B*s)
  return(out)
}
```

```{r gamma d.d. qualitative plot, echo=F}
n.vec.test <- seq(1,4000,by=50)
G.test <- sapply(n.vec.test,G,B=B,a=a,f.vec=f.vec,ext=ext,gamma=gamma)
plot(n.vec.test,G.test, type='l',xaxt='n',yaxt='n', main='Density-dependent settler survival',xlab='Number of initial settlers', ylab='Number surviving to age 1')
```

The matrix formulation for this population will be qualitatively the density-independent population above, but with the change that the top row of the matrix, specifying the contribution of reproduction to the age-1 cohort ($N_{1}$), will be a function, $\Gamma(S)$, instead of a constant, and consequently the specific values of those matrix cells will change each iteration during simulation (below).  Since for now, survival after age-1,  $p_{1}...p_{\omega-1}$, is still density independent and constant, the rows below in the Leslie matrix do not change from the D.I. case.

```{r Leslie matrix density dependent}
M.dd <- function (a, gamma, f.vec, p.vec,n.vec,ext, B) {
  M=matrix(nrow=max.age+1,ncol=max.age+1)
  ## Calls the G(S) function, which requires 3 new params: n.vec, ext, and B
  g <- G(a=a,f.vec=f.vec,n.vec=n.vec,ext=ext,gamma=gamma,B=B)
  r1 <- f.vec*a*g #first row, allowing for a partially open population and settler mortality in year 1
  M[1,] <-r1
  for (i in 2:(max.age+1)) { #rows 2 to max age
    row <- numeric(max.age+1)
    row[i-1] <- p.vec[i]
    M[i,] <- row
  }
  return(M)
}
```


## Simulations for Local Population

To start, we can explore the behavior of these models by simulating a virtual population, described by the parameters above, and look at patterns over time in age sructure and population dynamics.  First, for the density independent local population.

We can sample $a\in(0,1)$ from a skewed beta distribution, since in most years it will be very small.  $\xi$, the external larval supply, is sampled from a lognormal distribution.  The cv of both $a$ and $\xi$ are the same, cv=0.5.

```{r local d.i. population simulation 1, echo=FALSE,results='hide'}
estBetaParams <- function(mu, cv) { # estimates parameters for a beta distribution, for a desired mean and cv
  var = (cv*mu)^2
  alpha <- ((1 - mu) / var - 1 / mu) * mu ^ 2
  beta <- alpha * (1 / mu - 1)
  return(params = list(alpha = alpha, beta = beta))
}
## for a mean of around 0.1% (0.001) for a, and a cv of 0.5, the parameters are:

ext.meanlog <- 6.67
ext.sdlog <- 0.47

estlnormParams <- function(mean,cv) { #estimates location and scale parameters for a lognormal distribution for a desired mean and cv, for use in R's rlnorm function
  var = (cv*mean)^2
  scale <- sqrt(log(1+var/mean^2))
  loc <- log(mean)-scale/2
  return(params=list(meanlog=loc, sdlog=scale))
  }
## for a mean of around 0.1% (0.001) for a, and a cv of 0.5, the parameters are:

a.alpha <- 4
a.beta <- 4000

d.i.sim1 <- matrix(nrow=(max.age+1), ncol=sim.years)
d.i.simtot <- numeric()
Ninit <- rep(250,15)
d.i.sim1[,1] <- Ninit
d.i.simtot <- sum(Ninit)
a.rand <- rbeta(n=sim.years,shape1=a.alpha,shape2=a.beta) # a sampled from beta distribution
ext.rand <- rlnorm(n=sim.years,meanlog=ext.meanlog,sdlog=ext.sdlog) # ext sample from a lognormal distribution
for (i in 1:(sim.years-1)) {
  M <- M.di(a=a.rand[i], gamma=gamma, f.vec=f.vec, p.vec=p.vec)
  N.vec <- M%*%d.i.sim1[,i] + (gamma*ext.rand[i]*e.vec)
  d.i.sim1[,i+1] <- N.vec
  d.i.simtot[i+1] <- sum(N.vec)
  }
plot(1:sim.years,d.i.sim1[15,],type='l')
plot(1:sim.years,d.i.simtot,type='l')

sim1.props <- apply(d.i.sim1, MARGIN=2,FUN= function(x) x/sum(x))
cols <- rainbow(15)
plot(150:160,sim1.props[1,150:160],col=cols[1],type='l')
for(i in 2:15){
  lines(150:160,sim1.props[i,150:160],col=cols[i],type='l')
}
```